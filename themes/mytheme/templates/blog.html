{# Blog feed page: single-column feed, sidebar, search #}
{% extends "base.html" %}
{% block content %}
<div class="blog-page">
  <div class="feed">
    {% for article in articles %}
    {# Data attributes carry the logic for search.js #}
    <article class="post-card" 
             data-tags="{% for t in article.tags %}{{ t|lower }},{% endfor %}"
             data-category="{{ article.category|lower if article.category else '' }}"
             data-search="{{ article.title|lower }} {{ article.summary|lower }} {{ article.category|lower if article.category else '' }}">
             
      <div style="display:flex; align-items:flex-start; gap:1rem; width:100%;">
        
        {# CHANGE 1: Clickable Image #}
        {% if article.metadata.get('image') %}
        <a href="{{ SITEURL }}{{ article.url }}" style="flex-shrink: 0; display: block;">
            <img class="thumb" src="{{ SITEURL }}/{{ article.metadata.get('image') }}" alt="{{ article.title }}">
        </a>
        {% endif %}

        <div style="flex:1; min-width:0;">
          <header class="post-head">
            <h2 class="post-title"><a href="{{ SITEURL }}{{ article.url }}">{{ article.title }}</a></h2>
            
            {# CHANGE 2 & 3: Date Format and Separator #}
            <div class="meta">
                {{ article.date.strftime('%a %d %b %Y') }} — {{ article.category }}
            </div>

          </header>
          <div class="post-summary">{{ article.summary }}</div>
          <p class="read-more"><a href="{{ SITEURL }}{{ article.url }}">Read →</a></p>
        </div>
      </div>
    </article>
    {% endfor %}
    
    <div class="no-results" style="display: none;">
      <p>No posts found matching your criteria.</p>
      <button class="btn btn-ghost" style="margin-top:1rem">Show all posts</button>
    </div>
  </div>
  
  <aside class="sidebar">
    <div class="sidebar-widget-group">
      <div class="search-box widget">
        <input type="text" id="search-input" placeholder="Search posts..." autocomplete="off" />
        <button type="button" id="clear-search" class="search-clear" aria-label="Clear search" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="widget">
        <h3>Categories</h3>
        <ul class="categories-list">
          {# "All" Button #}
          <li><button type="button" class="cat-badge category-filter active" data-filter="all">All</button></li>
          
          {% set seen_cats = [] %}
          {% for a in articles %}
            {% if a.category and a.category not in seen_cats %}
              {% set _ = seen_cats.append(a.category) %}
              <li>
                <button type="button" class="cat-badge category-filter" data-filter="{{ a.category|lower }}">{{ a.category }}</button>
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>

      <div class="widget">
        <h3>Popular Tags</h3>
        <ul class="categories-list" id="tags-list">
          {% if tags %}
            {# Use Pelican's global 'tags' variable: list of (tag, articles) tuples #}
            {% for tag, articles in tags %}
              {# We add data-count so JS can sort them #}
              <li class="tag-item" data-count="{{ articles|count }}" data-tag="{{ tag.name|lower }}">
                <button type="button" class="cat-badge tag-filter" data-tag="{{ tag.name|lower }}">
                  {{ tag.name }} 
                  <span style="opacity: 0.6; font-size: 0.8em; margin-left: 4px;">({{ articles|count }})</span>
                </button>
              </li>
            {% endfor %}
          {% else %}
             <li>No tags found.</li>
          {% endif %}
        </ul>
        
        <button id="show-more-tags" class="btn-text" style="display:none; margin-top: 10px; font-size: 0.85rem; color: var(--accent); cursor: pointer; background: none; border: none; padding: 0;">
            Show more...
        </button>
      </div>
      </div>
  </aside>
</div>

{# Link the modular JS files #}
<script src="{{ SITEURL }}/theme/js/search.js"></script>
<script src="{{ SITEURL }}/theme/js/tags.js"></script> {% endblock %}